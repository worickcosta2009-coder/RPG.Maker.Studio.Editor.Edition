<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>RPG Maker Studio - Dev Build</title>
    <style>
        body { background: #181818; color: #ccc; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        /* Toolbar */
        .tools { background: #202020; padding: 10px; display: flex; gap: 10px; border-bottom: 1px solid #333; align-items: center; }
        .sep { width: 1px; height: 30px; background: #333; margin: 0 5px; }
        
        label { font-size: 10px; font-weight: bold; color: #666; text-transform: uppercase; display: block; }
        
        select, input { background: #333; border: 1px solid #444; color: white; padding: 4px; border-radius: 3px; }
        input[type="number"] { width: 40px; text-align: center; }
        
        button { background: #333; color: #ddd; border: 1px solid #444; padding: 5px 10px; cursor: pointer; border-radius: 3px; display: flex; align-items: center; gap: 5px;}
        button:hover { background: #444; }
        button:active { transform: translateY(1px); }
        .btn-blue { background: #007acc; border-color: #005a9e; color: white; }
        .btn-blue:hover { background: #005a9e; }
        
        /* Layout */
        .main { flex: 1; display: flex; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; border-right: 2px solid #333; min-width: 0; }
        
        .header { background: #252526; padding: 5px 10px; font-size: 11px; font-weight: bold; color: #888; display: flex; justify-content: space-between; border-bottom: 1px solid #333; }
        
        .viewport { flex: 1; overflow: auto; background: #111; display: grid; place-items: center; position: relative; }
        
        /* Canvas */
        canvas { 
            image-rendering: pixelated; 
            box-shadow: 0 0 20px #000; 
            display: block; 
        }
        .bg-check {
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
        }

        /* Footer */
        .bar { background: #007acc; color: white; padding: 2px 10px; font-size: 11px; display: flex; justify-content: space-between; font-weight: bold; }
        
        /* Utils */
        .hide { display: none; }
    </style>
</head>
<body>

    <div class="tools">
        <div>
            <label>Tipo</label>
            <select id="selMode">
                <option value="tileset">Tileset (32px)</option>
                <option value="char">Charset</option>
                <option value="faceset">Faceset</option>
                <option value="free">Livre</option>
            </select>
        </div>

        <div class="sep"></div>

        <div>
            <label>Grid (W/H)</label>
            <div style="display:flex; gap:2px">
                <input type="number" id="inpW" value="32">
                <input type="number" id="inpH" value="32">
            </div>
        </div>
        
        <div>
            <label>Zoom</label>
            <input type="range" id="rngZoom" min="1" max="4" step="0.5" value="1" style="width:60px">
        </div>

        <div class="sep"></div>
        <button onclick="undo()">↩ Desfazer</button>

        <div style="margin-left: auto; display:flex; gap: 10px;">
            <button onclick="$('fSrc').click()"> Abrir Origem</button>
            <button onclick="$('fDest').click()"> Editar Base</button>
            <button class="btn-blue" onclick="save()"> Salvar</button>
            
            <input type="file" id="fSrc" class="hide" accept="image/*">
            <input type="file" id="fDest" class="hide" accept="image/*">
        </div>
    </div>

    <div class="main">
        <!-- Esquerda -->
        <div class="panel">
            <div class="header">
                <span>ORIGEM</span> <span style="color:#007acc">Segure & Arraste</span>
            </div>
            <div class="viewport bg-check" id="wrapSrc">
                <canvas id="cSrc" style="cursor: crosshair;"></canvas>
            </div>
        </div>

        <!-- Direita -->
        <div class="panel">
            <div class="header">
                <span>DESTINO</span> <span>Esq: Colar | Dir: Apagar</span>
            </div>
            <div class="viewport bg-check" id="wrapDest">
                <canvas id="cDest" style="cursor: none;"></canvas>
            </div>
        </div>
    </div>

    <div class="bar">
        <span id="log">Pronto.</span>
        <span id="pos">0, 0</span>
    </div>

    <script>
        const $ = id => document.getElementById(id); // atalho basico

        // Globais
        let grid = { w: 32, h: 32 };
        let state = {
            zoom: 1,
            selecting: false,
            pStart: {x:0, y:0},
            rect: {x:0, y:0, w:0, h:0},
            clip: null, // bitmap copiado
            history: [],
            hIdx: -1
        };

        const cSrc = $('cSrc');
        const cDest = $('cDest');
        const ctxS = cSrc.getContext('2d', { willReadFrequently: true });
        const ctxD = cDest.getContext('2d', { willReadFrequently: true });
        
        // Imagens carregadas
        let imgS = null;

        // Init rapido
        ctxS.imageSmoothingEnabled = false;
        ctxD.imageSmoothingEnabled = false;
        resizeDest(512, 512);

        // --- Eventos da UI ---

        $('selMode').onchange = function() {
            let m = this.value;
            let w=32, h=32;
            if(m === 'faceset') { w=96; h=96; }
            if(m === 'free') { w=1; h=1; }
            $('inpW').value = w;
            $('inpH').value = h;
            updateGrid();
        };

        $('inpW').onchange = updateGrid;
        $('inpH').onchange = updateGrid;
        
        $('rngZoom').oninput = function() {
            state.zoom = this.value;
            cSrc.style.transform = `scale(${state.zoom})`;
            cDest.style.transform = `scale(${state.zoom})`;
            // hack pra centralizar no scroll
            let pad = (state.zoom - 1) * 100;
            $('wrapSrc').style.padding = pad + 'px';
            $('wrapDest').style.padding = pad + 'px';
        };

        function updateGrid() {
            grid.w = parseInt($('inpW').value) || 32;
            grid.h = parseInt($('inpH').value) || 32;
            drawSrc();
        }

        // --- Core Logic ---

        function drawSrc() {
            if(!imgS) return;
            ctxS.clearRect(0,0, cSrc.width, cSrc.height);
            ctxS.drawImage(imgS, 0, 0);

            // Grade simples
            ctxS.beginPath();
            ctxS.strokeStyle = 'rgba(255,255,255,0.2)';
            for(let x=0; x<=cSrc.width; x+=grid.w) { ctxS.moveTo(x,0); ctxS.lineTo(x,cSrc.height); }
            for(let y=0; y<=cSrc.height; y+=grid.h) { ctxS.moveTo(0,y); ctxS.lineTo(cSrc.width,y); }
            ctxS.stroke();

            // Seleção
            if(state.rect.w > 0) {
                ctxS.strokeStyle = '#00e5ff';
                ctxS.lineWidth = 2;
                ctxS.fillStyle = 'rgba(0, 122, 204, 0.3)';
                ctxS.fillRect(state.rect.x, state.rect.y, state.rect.w, state.rect.h);
                ctxS.strokeRect(state.rect.x, state.rect.y, state.rect.w, state.rect.h);
            }
        }

        function drawDest(gx, gy) {
            // Limpa e redesenha do histórico atual
            if(state.history[state.hIdx]) {
                ctxD.putImageData(state.history[state.hIdx], 0, 0);
            } else {
                ctxD.clearRect(0,0, cDest.width, cDest.height);
            }

            // Ghost do clipboard
            if(state.clip && gx !== undefined) {
                ctxD.save();
                ctxD.globalAlpha = 0.6;
                ctxD.drawImage(state.clip, gx, gy);
                ctxD.strokeStyle = '#00e5ff';
                ctxD.strokeRect(gx, gy, state.rect.w, state.rect.h);
                ctxD.restore();
            }
        }

        // --- Mouse Origem (Seleção) ---

        cSrc.onmousedown = e => {
            if(!imgS) return;
            state.selecting = true;
            let p = getPos(cSrc, e);
            state.pStart = p;
            state.rect = { x: p.x, y: p.y, w: grid.w, h: grid.h };
            drawSrc();
        };

        cSrc.onmousemove = e => {
            if(!state.selecting) return;
            let p = getPos(cSrc, e);
            
            // Logica de arrastar retangulo
            let x = Math.min(state.pStart.x, p.x);
            let y = Math.min(state.pStart.y, p.y);
            let w = Math.abs(p.x - state.pStart.x) + grid.w;
            let h = Math.abs(p.y - state.pStart.y) + grid.h;
            
            state.rect = {x, y, w, h};
            drawSrc();
        };

        window.onmouseup = () => {
            if(state.selecting) {
                state.selecting = false;
                // Copiar para memoria
                ctxS.drawImage(imgS, 0, 0); // remove overlay pra copiar limpo
                let data = ctxS.getImageData(state.rect.x, state.rect.y, state.rect.w, state.rect.h);
                drawSrc(); // volta overlay
                
                createImageBitmap(data).then(bmp => {
                    state.clip = bmp;
                    log(`Copiado: ${state.rect.w}x${state.rect.h}`);
                });
            }
        };

        // --- Mouse Destino (Colar) ---

        cDest.onmousemove = e => {
            let p = getPos(cDest, e);
            $('pos').innerText = `${p.x}, ${p.y}`;
            drawDest(p.x, p.y);
        };
        
        cDest.onmouseleave = () => drawDest();

        cDest.onmousedown = e => {
            let p = getPos(cDest, e);
            
            if(e.button === 0 && state.clip) {
                // Colar
                // ctxD.clearRect(p.x, p.y, state.rect.w, state.rect.h); // descomentar se quiser apagar fundo
                ctxD.drawImage(state.clip, p.x, p.y);
                pushHistory();
                drawDest(p.x, p.y);
            } 
            else if(e.button === 2) {
                // Borracha
                ctxD.clearRect(p.x, p.y, state.rect.w || grid.w, state.rect.h || grid.h);
                pushHistory();
                drawDest(p.x, p.y);
            }
        };

        cDest.oncontextmenu = e => e.preventDefault();

        // --- Helpers ---

        function getPos(canvas, e) {
            let r = canvas.getBoundingClientRect();
            let rx = (e.clientX - r.left) / state.zoom;
            let ry = (e.clientY - r.top) / state.zoom;
            // Snap
            return {
                x: Math.floor(rx / grid.w) * grid.w,
                y: Math.floor(ry / grid.h) * grid.h
            };
        }

        function resizeDest(w, h) {
            cDest.width = w;
            cDest.height = h;
            ctxD.imageSmoothingEnabled = false;
            pushHistory();
            drawDest();
        }

        // --- Undo / History ---
        
        function pushHistory() {
            let data = ctxD.getImageData(0, 0, cDest.width, cDest.height);
            // Corta histórico se voltamos no tempo
            state.history = state.history.slice(0, state.hIdx + 1);
            state.history.push(data);
            if(state.history.length > 15) state.history.shift(); // max 15
            else state.hIdx++;
        }

        function undo() {
            if(state.hIdx > 0) {
                state.hIdx--;
                let data = state.history[state.hIdx];
                ctxD.putImageData(data, 0, 0);
                drawDest();
                log("Desfeito.");
            }
        }

        // --- Files ---

        $('fSrc').onchange = function() { loadImg(this, true); };
        $('fDest').onchange = function() { loadImg(this, false); };

        function loadImg(input, isSrc) {
            if(!input.files[0]) return;
            let img = new Image();
            img.onload = () => {
                if(isSrc) {
                    imgS = img;
                    cSrc.width = img.width;
                    cSrc.height = img.height;
                    ctxS.imageSmoothingEnabled = false;
                    drawSrc();
                } else {
                    resizeDest(img.width, img.height);
                    ctxD.drawImage(img, 0, 0);
                    pushHistory();
                }
            };
            img.src = URL.createObjectURL(input.files[0]);
            input.value = '';
        }

        function save() {
            let link = document.createElement('a');
            // Hack pra baixar o buffer atual do canvas
            // Precisamos renderizar o histórico puro sem o ghost
            let temp = document.createElement('canvas');
            temp.width = cDest.width; temp.height = cDest.height;
            temp.getContext('2d').putImageData(state.history[state.hIdx], 0, 0);
            
            link.download = 'tileset_edit.png';
            link.href = temp.toDataURL();
            link.click();
        }
        
        function log(msg) { $('log').innerText = msg; }
        
        // Atalho Ctrl+Z
        document.addEventListener('keydown', e => {
            if(e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
        });

    </script>
</body>
</html>
